<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="../dist/iife/babylonjs-spine.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body,
    html {
      height: 100%;
    }

    canvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
  <body>
    <canvas id="renderCanvas"></canvas>
    <script>
      let engine, scene;
      let assetManager;
      let skeletonMesh;

      // Paths to your Spine files (adjust these for your own folder/filenames)
      let baseUrl = "assets/";
      let skeletonFile = "raptor-pro.json";
      let atlasFile = "raptor.atlas";
      let animation = "walk"; // The name of the animation to play

      /**
       * Initializes Babylon engine and scene.
       */
      function init() {
        // Get canvas
        const canvas = document.getElementById("renderCanvas");

        // Create engine
        engine = new BABYLON.Engine(canvas, true);

        // Create a scene
        scene = new BABYLON.Scene(engine);

        var camera = new BABYLON.FreeCamera(
          "camera1",
          new BABYLON.Vector3(0, 5, -10),
          scene,
        );
        // Target the camera to scene origin
        camera.setTarget(BABYLON.Vector3.Zero());
        // Attach the camera to the canvas
        //camera.attachControl(canvas, false);

        var light = new BABYLON.HemisphericLight(
          "light1",
          new BABYLON.Vector3(0, 1, 0),
          scene,
        );

        /*var sphere = BABYLON.Mesh.CreateSphere(
          "sphere1",
          16,
          2,
          scene,
          false,
          BABYLON.Mesh.FRONTSIDE,
        );
        // Move the sphere upward 1/2 of its height
        sphere.position.y = 1;*/
        // Create a built-in "ground" shape; its constructor takes 6 params : name, width, height, subdivision, scene, updatable
        var ground = BABYLON.Mesh.CreateGround(
          "ground1",
          6,
          6,
          2,
          scene,
          false,
        );
        // Return the created scene

        // Create an asset manager for Spine
        assetManager = new spine.AssetManager(scene, baseUrl);

        // Queue loads for skeleton JSON and its atlas
        assetManager.loadText(skeletonFile);
        assetManager.loadTextureAtlas(atlasFile);

        // Once the assets are queued, start the render loop
        engine.runRenderLoop(() => {
          if (assetManager.isLoadingComplete() && !skeletonMesh) {
            // Load skeleton once everything is ready
            loadSkeleton();
          }
          if (skeletonMesh) {
            // Calculate delta time for spine animation
            const deltaTime = engine.getDeltaTime() / 1000;
            skeletonMesh.update(deltaTime);
          }
          scene.render();
        });

        // Handle window resize
        window.addEventListener("resize", () => {
          engine.resize();
        });
      }

      /**
       * Called when the AssetManager has finished loading all required assets.
       * Creates the Spine SkeletonMesh and adds it to the scene.
       */
      function loadSkeleton() {
        // Retrieve text data for .json
        const jsonData = assetManager.require(skeletonFile);

        // Retrieve the atlas (which also has the .png loaded)
        const atlas = assetManager.require(atlasFile);

        // Create the AtlasAttachmentLoader from your atlas
        const atlasLoader = new spine.AtlasAttachmentLoader(atlas);

        // Create a SkeletonJson parser
        const skeletonJson = new spine.SkeletonJson(atlasLoader);
        skeletonJson.scale = 0.003; // scale your model if needed

        // Parse skeleton data
        const skeletonData = skeletonJson.readSkeletonData(jsonData);

        // Create the SkeletonMesh
        skeletonMesh = new spine.SkeletonMesh("skeletonData", scene, {
          skeletonData,
        });

        // Set an animation
        skeletonMesh.animationState.setAnimation(0, animation, true);

        // Adjust skeletonMesh position or rotation if you like
        // skeletonMesh.position.y = -100;

        // Add skeletonMesh's root node to the Babylon scene
        // (Since SkeletonMesh extends TransformNode, we can just add it to the scene)
        skeletonMesh.setParent(scene.rootNodes[0]);
      }

      // Start everything
      init();
    </script>
  </body>
</html>
