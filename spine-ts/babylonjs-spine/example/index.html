<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="../dist/iife/babylonjs-spine.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body,
    html {
      height: 100%;
    }

    canvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
  <body>
    <canvas id="renderCanvas"></canvas>
    <script>
      let skeletonFile = "assets/raptor-pro.json";
      let atlasFile = skeletonFile
        .replace("-pro", "")
        .replace("-ess", "")
        .replace(".json", ".atlas");
      let animation = "walk";

      // Get the canvas DOM element
      var canvas = document.getElementById("renderCanvas");
      // Load the 3D engine
      var engine = new BABYLON.Engine(canvas, true, {
        preserveDrawingBuffer: true,
        stencil: true,
      });
      // CreateScene function that creates and return the scene
      var createScene = function () {
        // Create a basic BJS Scene object
        var scene = new BABYLON.Scene(engine);
        // Create a FreeCamera, and set its position to {x: 0, y: 5, z: -10}
        var camera = new BABYLON.FreeCamera(
          "camera1",
          new BABYLON.Vector3(0, 5, -10),
          scene,
        );
        // Target the camera to scene origin
        camera.setTarget(BABYLON.Vector3.Zero());
        // Attach the camera to the canvas
        camera.attachControl(canvas, false);
        // Create a basic light, aiming 0, 1, 0 - meaning, to the sky
        var light = new BABYLON.HemisphericLight(
          "light1",
          new BABYLON.Vector3(0, 1, 0),
          scene,
        );
        // Return the created scene
        return scene;
      };
      // call the createScene function
      var scene = createScene();

      var assetManager = new spine.AssetManager(scene);
      assetManager.loadText(skeletonFile);
      assetManager.loadTextureAtlas(atlasFile);

      function load(name, scale) {
        if (assetManager.isLoadingComplete()) {
          const atlas = assetManager.require(atlasFile);
          const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
          const skeletonJson = new spine.SkeletonJson(atlasLoader);

          skeletonJson.scale = 0.4;
          const skeletonData = skeletonJson.readSkeletonData(
            assetManager.require(skeletonFile),
          );

          skeletonMesh = new spine.SkeletonMesh({ skeletonData });
          skeletonMesh.state.setAnimation(0, animation, true);
          mesh.add(skeletonMesh);
        } else requestAnimationFrame(load);
      }
      requestAnimationFrame(load);

      // run the render loop
      engine.runRenderLoop(function () {
        scene.render();
      });
      // the canvas/window resize event handler
      window.addEventListener("resize", function () {
        engine.resize();
      });
    </script>
  </body>
</html>
